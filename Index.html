<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Enhanced Daily Workflow Planner</title>
  <!-- Preconnect to frequently used CDNs for faster loading -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://www.gstatic.com">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for Theming */
    :root {
      /* Light Mode Defaults */
      --body-bg-start: #f5f7fa;
      --body-bg-end: #c3cfe2;
      --text-color: #333;
      --header-bg: #3498db;
      --header-text: white;
      --container-bg: white;
      --section-bg: #f8f9fa;
      --table-header-bg: #3498db;
      --table-header-text: white;
      --table-row-even-bg: #f9f9f9;
      --table-row-hover-bg: #f1f9ff;
      --time-column-color: #555;
      --input-bg: #f0f8ff;
      --input-border: #add8e6;
      --input-focus-shadow: rgba(52, 152, 219, 0.5);
      --modal-bg: white;
      --modal-h2-color: #3498db;
      --modal-input-border: #ddd;
      --error-color: #e74c3c;
      --info-bg: #e3f2fd;
      --info-h2-color: #1565c0;
      --logged-out-msg-bg: #fdf2f2;
      --logged-out-msg-border: #f9dede;
      --task-template-select-bg: #e6f2ff;
      --task-template-select-border: #b3d9ff;
      --task-template-select-color: #3498db;
      --my-task-item-border: #eee;
    }

    /* Dark Mode Overrides */
    body.dark-mode {
      --body-bg-start: #212121;
      --body-bg-end: #323232;
      --text-color: #e0e0e0;
      --header-bg: #1a1a1a;
      --header-text: #f0f0f0;
      --container-bg: #3c3c3c;
      --section-bg: #4a4a4a;
      --table-header-bg: #1a1a1a;
      --table-header-text: #f0f0f0;
      --table-row-even-bg: #424242;
      --table-row-hover-bg: #525252;
      --time-column-color: #c0c0c0;
      --input-bg: #5a5a5a;
      --input-border: #6a6a6a;
      --input-focus-shadow: rgba(100, 181, 246, 0.5); /* Lighter blue for dark mode focus */
      --modal-bg: #3c3c3c;
      --modal-h2-color: #64b5f6; /* Lighter blue for dark mode modal title */
      --modal-input-border: #5a5a5a;
      --error-color: #ff8a80; /* Lighter red for dark mode error */
      --info-bg: #303f9f;
      --info-h2-color: #bbdefb;
      --logged-out-msg-bg: #424242;
      --logged-out-msg-border: #5a5a5a;
      --task-template-select-bg: #424242;
      --task-template-select-border: #64b5f6;
      --task-template-select-color: #bbdefb;
      --my-task-item-border: #5a5a5a;
    }

    /* Global Styles using variables */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--body-bg-start) 0%, var(--body-bg-end) 100%);
      color: var(--text-color);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transition */
    }

    /* REMOVED: blur effect for body.modal-open .container */
    /* Kept for scroll prevention ONLY: */
    body.modal-open {
      overflow: hidden; /* Prevent scrolling of background content */
    }

    /* General UI Elements */
    input, textarea, select, button {
      font-family: inherit; /* Ensure font is inherited for inputs */
      transition: all 0.2s ease-in-out;
      border-radius: 6px;
    }

    input:focus, textarea:focus, select:focus, button:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--input-focus-shadow);
    }

    button {
      cursor: pointer;
      padding: 10px 15px;
      border: none;
      font-weight: 500;
      color: var(--header-text); /* Buttons use header text color */
      background: var(--header-bg); /* Buttons use header background color */
    }

    button:hover:not(:disabled) {
      background: #2980b9; /* Specific hover for primary button */
      transform: translateY(-1px);
    }
    body.dark-mode button:hover:not(:disabled) { /* Dark mode hover override */
      background: #3a506b;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Container & Header */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--container-bg);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: background-color 0.3s ease; /* Smooth theme transition */
    }

    header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 25px 20px;
      text-align: center;
      border-bottom: 5px solid #2980b9;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      transition: background-color 0.3s ease, color 0.3s ease, border-bottom-color 0.3s ease; /* Smooth theme transition */
    }
    body.dark-mode header {
        border-bottom-color: #2c3e50; /* Darker border for dark mode header */
    }


    header h1 {
      font-size: 2.5rem;
      margin-bottom: 5px;
      flex-basis: 100%;
    }

    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      flex-basis: 100%;
    }

    #auth-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-grow: 1;
    }

    #login-btn { background: #4caf50; }
    #login-btn:hover:not(:disabled) { background: #449d48; }
    #logout-btn { background: #f44336; }
    #logout-btn:hover:not(:disabled) { background: #d03d2f; }

    #dark-mode-toggle { /* New Dark Mode Toggle Button */
      background: none;
      color: var(--header-text);
      border: 1px solid var(--header-text);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }
    #dark-mode-toggle:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    body.dark-mode #dark-mode-toggle {
        border-color: #f0f0f0;
        background: rgba(0,0,0,0.2);
    }
    body.dark-mode #dark-mode-toggle:hover:not(:disabled) {
        background: rgba(0,0,0,0.4);
    }


    #user-status {
      margin: 0 10px;
      font-weight: 500;
      display: flex;
      align-items: center;
    }

    #reset-day {
      background: #e74c3c;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    #reset-day:hover:not(:disabled) {
      background: #c0392b;
    }

    #quick-add-task-btn, #manage-tasks-btn {
        background: #9b59b6;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.95rem;
    }
    #quick-add-task-btn:hover:not(:disabled), #manage-tasks-btn:hover:not(:disabled) {
        background: #8e44ad;
    }

    /* Main Content Layout */
    .main-content {
      display: flex;
      flex-direction: column;
      padding: 25px;
      gap: 25px;
    }

    @media (min-width: 900px) {
      .main-content {
        flex-direction: row;
      }
      header {
        justify-content: space-between;
      }
      header h1, header .subtitle {
        flex-basis: auto;
      }
    }

    /* Date Selector */
    .date-selector {
      background: var(--section-bg);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease;
    }

    .date-selector h2 {
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 1.6rem;
    }
    body.dark-mode .date-selector h2 { color: var(--text-color); }


    .date-picker {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      width: 100%;
      max-width: 250px;
      background-color: var(--input-bg);
      color: var(--text-color);
    }

    .date-display {
      font-size: 1.3rem;
      margin: 15px 0;
      font-weight: 600;
      color: #3498db;
    }
    body.dark-mode .date-display { color: #64b5f6; } /* Lighter blue for dark mode */


    /* Planner Table */
    .planner-container {
      flex: 1;
      overflow-x: auto;
    }

    .planner-table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      min-width: 900px;
    }

    .planner-table th {
      background: var(--table-header-bg);
      color: var(--table-header-text);
      padding: 18px 12px;
      text-align: center;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 1.05rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .planner-table td {
      padding: 15px 12px;
      border-bottom: 1px solid #eaeaea;
      vertical-align: top;
    }
    body.dark-mode .planner-table td { border-bottom-color: #5a5a5a; }

    .planner-table tr:nth-child(even) {
      background-color: var(--table-row-even-bg);
    }

    .planner-table tr:hover {
      background-color: var(--table-row-hover-bg);
    }

    /* Column Widths */
    .time-column {
      width: 8%;
      min-width: 80px;
      text-align: center;
      font-weight: 600;
      color: var(--time-column-color);
    }
    .task-column {
      width: 28%;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .done-column { width: 25%; min-width: 220px; }
    .priority-column { width: 12%; min-width: 100px; text-align: center; }
    .status-column { width: 12%; min-width: 100px; text-align: center; }

    /* Textarea & Inputs */
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
      background-color: var(--input-bg);
      color: var(--text-color);
    }
    body.dark-mode input, body.dark-mode select { border-color: var(--input-border); }

    textarea {
      min-height: 80px;
      resize: vertical;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 12px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    textarea:focus {
      box-shadow: 0 0 5px var(--input-focus-shadow), inset 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Priority Selector Styles */
    .priority-select {
      margin-top: 5px;
      padding: 6px 8px;
      border: 1px solid var(--modal-input-border);
      border-radius: 4px;
      font-size: 0.9rem;
      background-color: var(--container-bg); /* Use container bg for selects */
      color: var(--text-color);
    }

    /* Visual indicators for priority on task textarea */
    .task-textarea.priority-low { border-left: 5px solid #2ecc71; padding-left: 7px; }
    .task-textarea.priority-medium { border-left: 5px solid #f39c12; padding-left: 7px; }
    .task-textarea.priority-high { border-left: 5px solid #e74c3c; padding-left: 7px; }

    /* Task Template Select */
    .task-template-select {
      padding: 8px;
      border: 1px solid var(--task-template-select-border);
      background-color: var(--task-template-select-bg);
      color: var(--task-template-select-color);
      font-weight: 500;
      border-radius: 5px;
      cursor: pointer;
    }
    .task-template-select option {
      color: var(--text-color);
      background-color: var(--input-bg);
    }

    /* Status Buttons */
    .status-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 5px;
    }

    .status-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.3rem;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .status-btn:hover:not(.active):not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    body.dark-mode .status-btn:hover:not(.active):not(:disabled) {
      box-shadow: 0 0 5px rgba(255,255,255,0.2);
    }

    .completed-btn { background: #e8f5e9; color: #4caf50; }
    .completed-btn.active { background: #4caf50; color: white; border-color: #2e7d32; }
    .completed-btn.active:hover:not(:disabled) { background: #2e7d32; }

    .lost-btn { background: #ffebee; color: #f44336; }
    .lost-btn.active { background: #f44336; color: white; border-color: #c62828; }
    .lost-btn.active:hover:not(:disabled) { background: #c62828; }

    /* Progress Section */
    .progress-section {
      background: var(--section-bg);
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease;
    }

    .progress-section h2 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 1.6rem;
    }
    body.dark-mode .progress-section h2 { color: var(--text-color); }

    #period-selector {
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      background-color: var(--container-bg);
      color: var(--text-color);
    }

    .chart-container {
      position: relative;
      width: 250px;
      height: 250px;
      margin: 0 auto 20px;
    }

    #progress-text {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-color);
    }

    .day-status {
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .status-done {
      background: #e8f5e9;
      color: #2e7d32;
      border: 2px solid #4caf50;
    }

    .status-lost {
      background: #ffebee;
      color: #c62828;
      border: 2px solid #f44336;
    }

    /* Instructions */
    .instructions {
      margin-top: 30px;
      padding: 25px;
      background: var(--info-bg);
      border-radius: 10px;
      font-size: 0.95rem;
      line-height: 1.6;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease;
    }

    .instructions h2 {
      margin-bottom: 15px;
      color: var(--info-h2-color);
      font-size: 1.4rem;
    }
    body.dark-mode .instructions h2 { color: var(--text-color); }


    .instructions ul {
      padding-left: 25px;
    }

    .instructions li {
      margin-bottom: 8px;
    }

    /* Modals (Auth & Quick Add & My Tasks) */
    #modalBackdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 999;
      transition: background-color 0.3s ease;
    }

    #authModal, #quickAddTaskModal, #myTasksModal {
      display: none; /* Ensure modals are hidden by default */
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--modal-bg);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.1);
      z-index: 1000;
      text-align: center;
      width: 90%;
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
      transition: background-color 0.3s ease;
    }

    #authModal h2, #quickAddTaskModal h2, #myTasksModal h2 {
      color: var(--modal-h2-color);
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    #authModal form, #quickAddTaskModal form, #myTasksModal div:has(input) {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #myTasksModal #newTaskTemplateInput {
        margin-top: 10px;
    }
    #myTasksModal button {
        margin-top: 5px;
    }


    #authModal input, #quickAddTaskModal input, #quickAddTaskModal select, #myTasksModal input {
      margin: 0;
      padding: 12px;
      border: 1px solid var(--modal-input-border);
      border-radius: 8px;
      font-size: 1rem;
      background-color: var(--input-bg);
      color: var(--text-color);
    }

    #authModal button, #quickAddTaskModal button, #myTasksModal button {
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1rem;
      margin-top: 5px;
    }

    /* Special Close buttons */
    #authModal .close-button,
    #quickAddTaskModal .close-button,
    #myTasksModal .close-button {
      background: #95a5a6;
      margin-top: 15px;
    }
    #authModal .close-button:hover,
    #quickAddTaskModal .close-button:hover,
    #myTasksModal .close-button:hover {
      background: #7f8c8d;
    }

    #authError { color: var(--error-color); margin-top: 10px; font-weight: 500; }
    #authLoading { color: #3498db; font-style: italic; margin-top: 10px; }
    #not-logged-in-message {
      display: none;
      color: var(--error-color);
      text-align: center;
      margin: 20px;
      padding: 15px;
      background: var(--logged-out-msg-bg);
      border: 1px solid var(--logged-out-msg-border);
      border-radius: 8px;
      font-weight: 500;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    body.dark-mode #not-logged-in-message {
        color: #ff8a80;
    }


    /* My Tasks List specific styles */
    #myTasksList {
        text-align: left;
        margin-top: 15px;
        padding: 0 10px;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--my-task-item-border);
        border-radius: 8px;
        background-color: var(--section-bg);
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .my-task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px dashed var(--my-task-item-border);
        font-size: 0.95rem;
    }
    .my-task-item:last-child {
        border-bottom: none;
    }
    .my-task-item span {
        flex-grow: 1;
        margin-right: 10px;
        color: var(--text-color);
    }
    .my-task-item .delete-task-btn {
        background: none;
        border: none;
        color: var(--error-color);
        font-size: 1.1rem;
        cursor: pointer;
        padding: 5px;
        margin: 0;
        line-height: 1;
        transition: color 0.2s;
    }
    .my-task-item .delete-task-btn:hover {
        color: #c0392b;
        transform: scale(1.1);
    }
    body.dark-mode .my-task-item .delete-task-btn:hover {
        color: #ff8a80;
    }
    .my-task-item .delete-task-btn:focus {
        box-shadow: none;
    }


    /* Mobile-specific adjustments for Modals */
    @media (max-width: 600px) {
      #authModal, #quickAddTaskModal, #myTasksModal {
        top: 50%;
        width: 95%;
        padding: 20px;
        font-size: 1rem;
      }
      #authModal input, #quickAddTaskModal input, #quickAddTaskModal select, #myTasksModal input { font-size: 1rem; padding: 10px; }
      #authModal button, #quickAddTaskModal button, #myTasksModal button { font-size: 1rem; padding: 12px; }
      body.modal-open { overflow: hidden; }
    }

    /* Custom scrollbar */
    .planner-container::-webkit-scrollbar { height: 12px; }
    .planner-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .planner-container::-webkit-scrollbar-thumb { background: #3498db; border-radius: 10px; }
    .planner-container::-webkit-scrollbar-thumb:hover { background: #2980b9; }
    body.dark-mode .planner-container::-webkit-scrollbar-track { background: #555; }
    body.dark-mode .planner-container::-webkit-scrollbar-thumb { background: #64b5f6; }
    body.dark-mode .planner-container::-webkit-scrollbar-thumb:hover { background: #42a5f5; }

  </style>
</head>
<body>
  <!-- Modal Backdrop -->
  <div id="modalBackdrop"></div>

  <div class="container">
    <header>
      <h1>Daily Workflow Planner</h1>
      <p class="subtitle">Plan your day hour by hour and track your progress</p>
      <div id="auth-section">
        <!-- Buttons now directly call toggleModal with specific modal and state -->
        <button id="login-btn" onclick="toggleModal(authModal, true)">Login</button>
        <button id="logout-btn">Logout</button>
        <span id="user-status">Not logged in</span>
      </div>
      <button id="dark-mode-toggle"><i class="fas fa-moon"></i> Dark Mode</button>
      <button id="quick-add-task-btn" onclick="toggleModal(quickAddTaskModal, true)"><i class="fas fa-plus"></i> Add Task</button>
      <button id="manage-tasks-btn" onclick="toggleModal(myTasksModal, true)"><i class="fas fa-tasks"></i> My Tasks</button>
      <button id="reset-day"><i class="fas fa-trash"></i> Reset Day</button>
    </header>

    <!-- Authentication Modal (Simplified: fields visible directly) -->
    <div id="authModal" style="display: none;">
      <h2>Sign In or Sign Up</h2>
      <form id="authForm">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password (at least 6 characters)" required>
        <button type="button" onclick="handleLogin()">Login</button>
        <button type="button" onclick="handleSignup()">Sign Up</button>
      </form>
      <p id="authError"></p>
      <p id="authLoading">Loading...</p>
      <button type="button" onclick="toggleModal(authModal, false)" class="close-button">Close</button>
    </div>

    <!-- Quick Add Task Modal -->
    <div id="quickAddTaskModal" style="display: none;">
      <h2>Quick Add New Task</h2>
      <form id="quickAddTaskForm">
        <input type="text" id="quick-task-description" placeholder="Task description" required>
        <select id="quick-task-hour">
          <!-- Hours will be populated by JS -->
        </select>
        <select id="quick-task-priority" class="priority-select">
          <option value="none">Priority: None</option>
          <option value="low">Priority: Low</option>
          <option value="medium">Priority: Medium</option>
          <option value="high">Priority: High</option>
        </select>
        <button type="button" onclick="handleQuickAddTask()">Add Task</button>
      </form>
      <button type="button" onclick="toggleModal(quickAddTaskModal, false)" class="close-button">Close</button>
    </div>

    <!-- My Tasks Modal -->
    <div id="myTasksModal" style="display: none;">
      <h2>My Task Templates</h2>
      <div id="myTasksList">
        <!-- User tasks will be listed here by JS -->
        <p style="text-align: center; color: #777;">No tasks added yet.</p>
      </div>
      <div>
        <input type="text" id="newTaskTemplateInput" placeholder="Enter new task template" maxlength="100">
        <button onclick="addQuickTaskTemplate()"><i class="fas fa-plus"></i> Add Template</button>
      </div>
      <button type="button" onclick="toggleModal(myTasksModal, false)" class="close-button">Close</button>
    </div>


    <p id="not-logged-in-message">You must log in to edit or save data. Data is cloud-only.</p>

    <div class="main-content">
      <div class="planner-section" style="flex: 1;">
        <div class="date-selector">
          <h2><i class="fas fa-calendar-alt"></i> Select Date</h2>
          <input type="date" id="date-picker" class="date-picker">
          <div class="date-display" id="date-display">Today: Loading...</div>
        </div>

        <div class="planner-container">
          <table class="planner-table">
            <thead>
              <tr>
                <th class="time-column">Time</th>
                <th class="task-column">Task To Be Done</th>
                <th class="priority-column">Priority</th>
                <th class="done-column">What Has Been Done</th>
                <th class="status-column">Status</th>
              </tr>
            </thead>
            <tbody id="planner-body">
              <!-- Rows will be generated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="progress-section">
        <h2 id="progress-title"><i class="fas fa-chart-pie"></i> Daily Progress</h2>
        <select id="period-selector">
          <option value="daily" selected>Daily</option>
          <option value="weekly">Weekly (Last 7 Days)</option>
          <option value="monthly">Monthly (Last 30 Days)</option>
        </select>
        <div class="chart-container">
          <canvas id="progress-chart"></canvas>
        </div>
        <div id="progress-text">Progress: 0% completed (of tracked hours)</div>
        <div class="day-status status-lost" id="period-status">Day Status: Not enough data</div>
      </div>
    </div>

    <div class="instructions">
      <h2><i class="fas fa-info-circle"></i> How to Use This Planner</h2>
      <ul>
        <li>Select a date using the date picker</li>
        <li>**New!** Use the "Add Task" button for quick entry.</li>
        <li>**New!** Manage reusable task templates with the "My Tasks" button.</li>
        <li>**New!** For each hour, you can type a task OR select a template from the dropdown.</li>
        <li>**New!** Press 'Enter' in task textareas for point-wise bullets.</li>
        <li>Set a priority (None, Low, Medium, High) for each task.</li>
        <li>After completion, update "What Has Been Done" (multi-line supported)</li>
        <li>Mark hours as Completed or Lost using Status buttons</li>
        <li>View your progress in the pie chart - if you complete more than 70% of tasks, your day is marked as "Done"</li>
        <li>Switch between daily, weekly, or monthly progress views using the dropdown</li>
        <li>**New!** Toggle Dark Mode for a different visual experience.</li>
      </ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, deleteDoc, collection, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxEayQ6LHBnn0s8lL544R3ivkzSj4IuDs",
      authDomain: "dailyplannerapp-fb657.firebaseapp.com",
      projectId: "dailyplannerapp-fb657",
      storageBucket: "dailyplannerapp-fb657.appspot.com",
      messagingSenderId: "664172946138",
      appId: "1:664172946138:web:a6ad2cd4d9b8f15cdd7be3",
      measurementId: "G-FD50RXMP56"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userTasks = [];
    let unsubscribeUserTasks = null;
    let progressChart = null;
    let chartInitialized = false;

    // --- Global element references (important for consistent access across functions) ---
    let authModal, quickAddTaskModal, myTasksModal, modalBackdrop;
    let emailInput, passwordInput;
    let quickTaskDescriptionInput, quickTaskHourSelect, quickTaskPrioritySelect;
    let newTaskTemplateInput, myTasksList;
    let plannerBody;

    // This array will hold references to all modals for consistent backdrop management
    const allModalElements = [];

    document.addEventListener('DOMContentLoaded', () => {
      // --- Assign DOM elements to global variables ---
      authModal = document.getElementById('authModal');
      quickAddTaskModal = document.getElementById('quickAddTaskModal');
      myTasksModal = document.getElementById('myTasksModal');
      modalBackdrop = document.getElementById('modalBackdrop');
      emailInput = document.getElementById('email');
      passwordInput = document.getElementById('password');
      quickTaskDescriptionInput = document.getElementById('quick-task-description');
      quickTaskHourSelect = document.getElementById('quick-task-hour');
      quickTaskPrioritySelect = document.getElementById('quick-task-priority');
      newTaskTemplateInput = document.getElementById('newTaskTemplateInput');
      myTasksList = document.getElementById('myTasksList');
      plannerBody = document.getElementById('planner-body');

      // Populate allModalElements array with actual DOM elements
      allModalElements.push(authModal, quickAddTaskModal, myTasksModal);
      // --- End global element assignment ---


      const authError = document.getElementById('authError');
      const authLoading = document.getElementById('authLoading');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const userStatus = document.getElementById('user-status');
      const notLoggedInMessage = document.getElementById('not-logged-in-message');
      const datePicker = document.getElementById('date-picker');
      const dateDisplay = document.getElementById('date-display');
      const progressText = document.getElementById('progress-text');
      const periodStatus = document.getElementById('period-status');
      const resetDayBtn = document.getElementById('reset-day');
      const periodSelector = document.getElementById('period-selector');
      const progressTitle = document.getElementById('progress-title');
      const quickAddTaskBtn = document.getElementById('quick-add-task-btn');
      const manageTasksBtn = document.getElementById('manage-tasks-btn');

      const darkModeToggle = document.getElementById('dark-mode-toggle');

      // --- Dark Mode Logic ---
      function applyDarkMode(isEnabled) {
        if (isEnabled) {
          document.body.classList.add('dark-mode');
          darkModeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
        } else {
          document.body.classList.remove('dark-mode');
          darkModeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
        }
        localStorage.setItem('darkModeEnabled', isEnabled);
      }

      window.toggleDarkMode = function() {
        const isEnabled = !document.body.classList.contains('dark-mode');
        applyDarkMode(isEnabled);
      };

      darkModeToggle.addEventListener('click', window.toggleDarkMode);

      const savedDarkMode = localStorage.getItem('darkModeEnabled');
      if (savedDarkMode === 'true') {
        applyDarkMode(true);
      } else {
        applyDarkMode(false);
      }
      // --- End Dark Mode Logic ---


      // Chart initialization function - called only when needed
      function initChart() {
        if (chartInitialized && progressChart) return;
        try {
          progressChart = new Chart(document.getElementById('progress-chart'), {
            type: 'pie',
            data: {
              labels: ['Completed', 'Lost', 'Pending'],
              datasets: [{
                data: [0, 0, 24],
                backgroundColor: ['#4caf50', '#f44336', '#9e9e9e'],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: (context) => `${context.label}: ${context.raw} hours`
                  }
                }
              }
            }
          });
          chartInitialized = true;
          console.log('Chart initialized successfully');
          updateProgressChart();
        } catch (error) {
          console.error('Chart init error:', error);
        }
      }

      // --- Modal Management (REVISED FOR RELIABILITY) ---
      // This is the single entry point for opening/closing ALL modals
      window.toggleModal = function(modalElement, show) {
        if (!modalElement) {
          console.error("toggleModal called with null modalElement. Check DOM element IDs.");
          return;
        }

        if (show) {
          // Show the specific modal
          modalElement.style.display = 'block';
          // Always show backdrop and lock body if any modal is being opened
          modalBackdrop.style.display = 'block';
          document.body.classList.add('modal-open');
          console.log(`${modalElement.id} shown.`);

          // Special setup for specific modals when they are shown
          if (modalElement === quickAddTaskModal) {
            quickTaskDescriptionInput.value = ''; // Reset form
            quickTaskHourSelect.value = new Date().getHours();
            quickTaskPrioritySelect.value = 'none';
          } else if (modalElement === myTasksModal) {
            newTaskTemplateInput.value = ''; // Reset form
            renderMyTasksList(); // Refresh task list
          } else if (modalElement === authModal) {
              authError.textContent = ''; // Clear auth errors on display
              authLoading.style.display = 'none';
              emailInput.value = ''; // Clear fields
              passwordInput.value = '';
              emailInput.focus(); // Focus email input
          }

        } else {
          // Hide the specific modal
          modalElement.style.display = 'none';
          console.log(`${modalElement.id} hidden.`);

          // Check if ANY other modal is still visible among ALL defined modals
          const anyModalStillVisible = allModalElements.some(m => m && m.style.display === 'block');

          if (!anyModalStillVisible) {
            // If NO modals are visible, hide backdrop and unlock body
            modalBackdrop.style.display = 'none';
            document.body.classList.remove('modal-open');
            console.log('All modals closed, hiding backdrop and unlocking body.');
          } else {
            console.log('Other modals still visible, keeping backdrop/body-lock.');
          }

          // Clear auth-specific state when authModal is hidden
          if (modalElement === authModal) {
              authError.textContent = '';
              authLoading.style.display = 'none';
          }
        }
      };
      // --- End REVISED Modal Management ---


      function authWithTimeout(authPromise) {
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Network timeout - try Wi-Fi or better signal and retry.')), 30000)
        );
        return Promise.race([authPromise, timeoutPromise]);
      }

      window.handleLogin = async () => {
        if (!navigator.onLine) {
          authError.textContent = 'No internet connection. Please connect to the internet and try again.';
          return;
        }
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
          authError.textContent = 'Please enter your email and password.';
          return;
        }
        authError.textContent = '';
        authLoading.style.display = 'block';
        console.log('Login attempt started with email:', email);
        try {
          await authWithTimeout(signInWithEmailAndPassword(auth, email, password));
          console.log('Login success');
          toggleModal(authModal, false); // Use new toggle function
        } catch (error) {
          console.error('Login error details:', error.code, error.message);
          let userFacingError = 'Login failed. Please check your credentials or network connection.';

          if (error.code === 'auth/network-request-failed') {
            userFacingError = 'Network error: Failed to connect to authentication server. Please check your internet connection (Wi-Fi recommended) and try again.';
          } else if (error.message.includes('Network timeout')) {
            userFacingError = 'Connection timed out. This can happen on unstable mobile networks. Please try again, consider switching to Wi-Fi if on mobile data.';
          } else if (error.code === 'auth/invalid-email') {
            userFacingError = 'Invalid email address format.';
          } else if (error.code === 'auth/user-not-found') {
            userFacingError = 'No user found with this email. Consider signing up.';
          } else if (error.code === 'auth/wrong-password') {
            userFacingError = 'Incorrect password. Please try again.';
          } else {
            userFacingError = error.message;
          }
          authError.textContent = userFacingError;
        } finally {
          authLoading.style.display = 'none';
        }
      };

      window.handleSignup = async () => {
        if (!navigator.onLine) {
          authError.textContent = 'No internet connection. Please connect to the internet and try again.';
          return;
        }
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
          authError.textContent = 'Please enter your email and password.';
          return;
        }
        if (password.length < 6) {
          authError.textContent = 'Password must be at least 6 characters.';
          return;
        }
        authError.textContent = '';
        authLoading.style.display = 'block';
        console.log('Signup attempt started with email:', email);
        try {
          await authWithTimeout(createUserWithEmailAndPassword(auth, email, password));
          console.log('Signup success');
          toggleModal(authModal, false); // Use new toggle function
        } catch (error) {
          console.error('Signup error details:', error.code, error.message);
          let userFacingError = 'Signup failed. Please check your credentials or network connection.';

          if (error.code === 'auth/network-request-failed') {
            userFacingError = 'Network error: Failed to connect to authentication server. Please check your internet connection (Wi-Fi recommended) and try again.';
          } else if (error.message.includes('Network timeout')) {
            userFacingError = 'Connection timed out. This can happen on unstable mobile networks. Please try again, consider switching to Wi-Fi if on mobile data.';
          } else if (error.code === 'auth/email-already-in-use') {
            userFacingError = 'This email is already registered. Please try logging in or use a different email.';
          } else if (error.code === 'auth/weak-password') {
            userFacingError = 'Password is too weak. It must be at least 6 characters.';
          } else {
            userFacingError = error.message;
          }
          authError.textContent = userFacingError;
        } finally {
          authLoading.style.display = 'none';
        }
      };

      window.handleQuickAddTask = async () => {
        if (!auth.currentUser) return;

        const taskDescription = quickTaskDescriptionInput.value.trim();
        const hour = parseInt(quickTaskHourSelect.value, 10);
        const priority = quickTaskPrioritySelect.value;

        if (!taskDescription) {
          alert('Please enter a task description.');
          return;
        }

        const targetTaskTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="task"]`);
        const targetPrioritySelect = document.querySelector(`select[data-hour="${hour}"][data-type="priority"]`);

        if (targetTaskTextarea) {
            targetTaskTextarea.value = taskDescription;
        }
        if (targetPrioritySelect) {
            targetPrioritySelect.value = priority;
        }

        await saveDayData();
        toggleModal(quickAddTaskModal, false); // Use new toggle function
      };

      window.addQuickTaskTemplate = async () => {
          if (!auth.currentUser) return;
          const taskText = newTaskTemplateInput.value.trim();
          if (!taskText) {
              alert('Please enter a task template.');
              return;
          }
          if (taskText.length > 100) {
              alert('Task template cannot exceed 100 characters.');
              return;
          }

          try {
              const userTasksRef = collection(db, 'users', auth.currentUser.uid, 'userTasks');
              await addDoc(userTasksRef, {
                  text: taskText,
                  createdAt: new Date()
              });
              newTaskTemplateInput.value = '';
              console.log('Task template added successfully.');
          } catch (error) {
              console.error('Error adding task template:', error);
              alert('Error adding task template: ' + error.message);
          }
      };

      window.deleteQuickTaskTemplate = async (docId) => {
          if (!auth.currentUser || !confirm('Are you sure you want to delete this task template?')) return;
          try {
              const taskDocRef = doc(db, 'users', auth.currentUser.uid, 'userTasks', docId);
              await deleteDoc(taskDocRef);
              console.log('Task template deleted successfully.');
          } catch (error) {
              console.error('Error deleting task template:', error);
              alert('Error deleting task template: ' + error.message);
          }
      };

      function renderMyTasksList() {
          myTasksList.innerHTML = '';
          if (userTasks.length === 0) {
              myTasksList.innerHTML = '<p style="text-align: center; color: #777; padding: 15px;">No tasks added yet.</p>';
              return;
          }

          userTasks.forEach(task => {
              const taskItem = document.createElement('div');
              taskItem.className = 'my-task-item';
              taskItem.innerHTML = `
                  <span>${task.text}</span>
                  <button class="delete-task-btn" onclick="deleteQuickTaskTemplate('${task.id}')">
                      <i class="fas fa-trash"></i>
                  </button>
              `;
              myTasksList.appendChild(taskItem);
          });
      }

      function populateTaskTemplateSelects() {
          document.querySelectorAll('.task-template-select').forEach(select => {
              const currentSelectedValue = select.value;
              select.innerHTML = '<option value="">Select a template (optional)</option>';
              userTasks.forEach(task => {
                  const option = document.createElement('option');
                  option.value = task.text;
                  option.textContent = task.text;
                  select.appendChild(option);
              });
              if (currentSelectedValue && Array.from(select.options).some(opt => opt.value === currentSelectedValue)) {
                  select.value = currentSelectedValue;
              } else {
                  select.value = '';
              }
          });
      }


      onAuthStateChanged(auth, (user) => {
        if (user) {
          userStatus.textContent = `Logged in as ${user.email}`;
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline';
          toggleModal(authModal, false); // Ensure auth modal closes on successful login
          notLoggedInMessage.style.display = 'none';
          enablePlanner(true);
          updateSubscriptions(user.uid);

          if (unsubscribeUserTasks) unsubscribeUserTasks();
          const userTasksRef = collection(db, 'users', user.uid, 'userTasks');
          const q = query(userTasksRef, orderBy('createdAt', 'asc'));
          unsubscribeUserTasks = onSnapshot(q, (snapshot) => {
              userTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              populateTaskTemplateSelects();
              if (myTasksModal.style.display === 'block') {
                  renderMyTasksList();
              }
              console.log('User tasks updated:', userTasks.length, 'templates');
          }, (error) => {
              console.error('Error fetching user tasks:', error);
          });

          if (!chartInitialized) {
              initChart();
          }
          console.log('User authenticated:', user.email);
        } else {
          userStatus.textContent = 'Not logged in';
          loginBtn.style.display = 'inline';
          logoutBtn.style.display = 'none';
          toggleModal(authModal, true); // Show auth modal when logged out
          notLoggedInMessage.style.display = 'block';
          enablePlanner(false);
          clearPlanner();
          dayListeners.forEach(unsub => unsub());
          dayListeners.clear();
          periodDataCache.clear();
          userTasks = [];
          if (unsubscribeUserTasks) {
              unsubscribeUserTasks();
              unsubscribeUserTasks = null;
          }
          populateTaskTemplateSelects();
          if (progressChart) {
              progressChart.destroy();
              progressChart = null;
              chartInitialized = false;
          }
          console.log('Unsubscribed from all Firestore listeners on logout');
        }
      });

      // Initial check on load: If not logged in after 1 sec, open auth modal
      setTimeout(() => {
        if (!auth.currentUser) {
          toggleModal(authModal, true);
          console.log('Forced auth modal show after delay for initial load because user is not logged in.');
        }
      }, 1000);

      logoutBtn.addEventListener('click', async () => {
        try {
          await signOut(auth);
          console.log('Logout successful');
        } catch (error) {
          console.error('Logout error:', error);
          alert('Error logging out: ' + error.message);
        }
      });

      const hours = Array.from({ length: 24 }, (_, i) => i);
      let selectedDate = new Date();
      let dayListeners = new Map();
      let periodDataCache = new Map();
      let currentPeriod = 'daily';

      datePicker.valueAsDate = selectedDate;
      updateDateDisplay();
      generatePlannerTable();
      populateQuickTaskHours();

      datePicker.addEventListener('change', () => {
        selectedDate = datePicker.valueAsDate;
        updateDateDisplay();
        if (auth.currentUser) {
          updateSubscriptions(auth.currentUser.uid);
          applyDataToTableFromCache();
        }
      });

      periodSelector.addEventListener('change', () => {
        currentPeriod = periodSelector.value;
        if (auth.currentUser) {
          updateSubscriptions(auth.currentUser.uid);
          updateProgressChart();
        }
        updateTitles();
      });

      resetDayBtn.addEventListener('click', () => {
        if (auth.currentUser && confirm('Reset this day? All data will be cleared.')) {
          resetDay();
        }
      });

      function updateDateDisplay() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateDisplay.textContent = selectedDate.toLocaleDateString('en-US', options);
      }

      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function updateTitles() {
        progressTitle.innerHTML = `<i class="fas fa-chart-pie"></i> ${capitalize(currentPeriod)} Progress`;
      }
      updateTitles();

      function populateQuickTaskHours() {
        quickTaskHourSelect.innerHTML = '';
        hours.forEach(hour => {
          const option = document.createElement('option');
          option.value = hour;
          option.textContent = formatHour(hour);
          quickTaskHourSelect.appendChild(option);
        });
        quickTaskHourSelect.value = new Date().getHours();
      }

      function generatePlannerTable() {
        while (plannerBody.firstChild) {
            plannerBody.removeChild(plannerBody.firstChild);
        }
        const fragment = document.createDocumentFragment();

        hours.forEach(hour => {
          const tr = document.createElement('tr');

          const tdTime = document.createElement('td');
          tdTime.className = 'time-column';
          tdTime.textContent = formatHour(hour);
          tr.appendChild(tdTime);

          const tdTask = document.createElement('td');
          tdTask.className = 'task-column';

          const taskTemplateSelect = document.createElement('select');
          taskTemplateSelect.className = 'task-template-select';
          taskTemplateSelect.dataset.hour = hour;
          taskTemplateSelect.innerHTML = '<option value="">Select a template (optional)</option>';
          taskTemplateSelect.addEventListener('change', (event) => {
              const selectedValue = event.target.value;
              const taskTextarea = event.target.nextElementSibling;
              if (selectedValue) {
                  taskTextarea.value = selectedValue;
              } else {
                  taskTextarea.value = '';
              }
              saveDayData();
          });
          tdTask.appendChild(taskTemplateSelect);

          const taskTextarea = document.createElement('textarea');
          taskTextarea.placeholder = 'Enter task to be done...';
          taskTextarea.dataset.hour = hour;
          taskTextarea.dataset.type = 'task';
          taskTextarea.className = 'task-textarea';
          taskTextarea.addEventListener('change', saveDayData);
          taskTextarea.addEventListener('keydown', handleBulletPoint);
          tdTask.appendChild(taskTextarea);
          tr.appendChild(tdTask);

          const tdPriority = document.createElement('td');
          tdPriority.className = 'priority-column';
          const prioritySelect = document.createElement('select');
          prioritySelect.className = 'priority-select';
          prioritySelect.dataset.hour = hour;
          prioritySelect.dataset.type = 'priority';
          prioritySelect.innerHTML = `
            <option value="none">None</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          `;
          prioritySelect.addEventListener('change', () => {
              saveDayData();
              updatePriorityVisual(taskTextarea, prioritySelect.value);
          });
          tdPriority.appendChild(prioritySelect);
          tr.appendChild(tdPriority);

          const tdDone = document.createElement('td');
          tdDone.className = 'done-column';
          const doneTextarea = document.createElement('textarea');
          doneTextarea.placeholder = 'What was accomplished...';
          doneTextarea.dataset.hour = hour;
          doneTextarea.dataset.type = 'done';
          doneTextarea.className = 'done-textarea';
          doneTextarea.addEventListener('change', saveDayData);
          doneTextarea.addEventListener('keydown', handleBulletPoint);
          tdDone.appendChild(doneTextarea);
          tr.appendChild(tdDone);

          const tdStatus = document.createElement('td');
          tdStatus.className = 'status-column';
          const statusButtons = document.createElement('div');
          statusButtons.className = 'status-buttons';

          const completedBtn = document.createElement('div');
          completedBtn.className = 'status-btn completed-btn';
          completedBtn.innerHTML = '<i class="fas fa-check"></i>';
          completedBtn.dataset.hour = hour;
          completedBtn.addEventListener('click', () => setStatus(hour, 'completed'));

          const lostBtn = document.createElement('div');
          lostBtn.className = 'status-btn lost-btn';
          lostBtn.innerHTML = '<i class="fas fa-times"></i>';
          lostBtn.dataset.hour = hour;
          lostBtn.addEventListener('click', () => setStatus(hour, 'lost'));

          statusButtons.appendChild(completedBtn);
          statusButtons.appendChild(lostBtn);
          tdStatus.appendChild(statusButtons);
          tr.appendChild(tdStatus);

          fragment.appendChild(tr);
        });
        plannerBody.appendChild(fragment);
        if (auth.currentUser) {
            populateTaskTemplateSelects();
        }
      }

      // --- New: Bullet Point Handler for Textareas ---
      function handleBulletPoint(event) {
        if (event.key === 'Enter') {
            event.preventDefault();

            const textarea = event.target;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const currentLine = value.substring(lineStart, start);

            if (currentLine.trim() === '-' || currentLine.trim() === '*') {
                textarea.value = value.substring(0, lineStart) + value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = lineStart;
            } else {
                const newValue = value.substring(0, start) + '\n- ' + value.substring(end);
                textarea.value = newValue;
                textarea.selectionStart = textarea.selectionEnd = start + 3;
            }
            saveDayData();
        } else if (event.key === 'Backspace') {
            const textarea = event.target;
            const start = textarea.selectionStart;
            const end = textarea.value.length;
            const value = textarea.value;

            if (start !== end) return;

            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
            const currentLine = value.substring(lineStart, start);

            if ((currentLine.endsWith('- ') || currentLine.endsWith('* ')) && (currentLine.trim().length === 1)) {
                const bulletPoint = currentLine.trim();
                const bulletLength = bulletPoint.length + 1; // "- " is 2 chars, "\n" is 1 = 3
                if (value.substring(start - bulletLength, start) === `\n${bulletPoint} `) {
                    event.preventDefault();
                    const newValue = value.substring(0, start - bulletLength) + value.substring(start);
                    textarea.value = newValue;
                    textarea.selectionStart = textarea.selectionEnd = start - bulletLength;
                    saveDayData();
                }
            }
        }
      }
      // --- End Bullet Point Handler ---


      function formatHour(hour) {
        if (hour === 0) return '12 AM';
        if (hour < 12) return `${hour} AM`;
        if (hour === 12) return '12 PM';
        return `${hour - 12} PM`;
      }

      function setStatus(hour, status) {
        if (!auth.currentUser) return;
        const completedBtn = document.querySelector(`.completed-btn[data-hour="${hour}"]`);
        const lostBtn = document.querySelector(`.lost-btn[data-hour="${hour}"]`);

        completedBtn.classList.remove('active');
        lostBtn.classList.remove('active');
        if (status === 'completed') completedBtn.classList.add('active');
        else if (status === 'lost') lostBtn.classList.add('active');

        saveDayData();
      }

      function updatePriorityVisual(taskTextarea, priority) {
          taskTextarea.classList.remove('priority-none', 'priority-low', 'priority-medium', 'priority-high');
          if (priority && priority !== 'none') {
              taskTextarea.classList.add(`priority-${priority}`);
          }
      }

      async function saveDayData() {
        if (!auth.currentUser) return;

        const dayData = { hours: {} };
        hours.forEach(hour => {
          const taskTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="task"]`);
          const doneTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="done"]`);
          const prioritySelect = document.querySelector(`select[data-hour="${hour}"][data-type="priority"]`);
          const completedBtn = document.querySelector(`.completed-btn[data-hour="${hour}"]`);
          const lostBtn = document.querySelector(`.lost-btn[data-hour="${hour}"]`);

          dayData.hours[hour] = {
            task: taskTextarea.value,
            done: doneTextarea.value,
            priority: prioritySelect ? prioritySelect.value : 'none',
            status: completedBtn.classList.contains('active') ? 'completed' :
                    (lostBtn.classList.contains('active') ? 'lost' : 'pending')
          };
        });

        try {
          const dateKey = selectedDate.toISOString().split('T')[0];
          await setDoc(doc(db, 'users', auth.currentUser.uid, 'days', dateKey), dayData);
          console.log('Saved to cloud');
        } catch (error) {
          console.error('Save error:', error);
          alert('Error saving data: ' + error.message);
        }
        updateProgressChart();
      }

      function subscribeToDay(uid, dateKey, selectedKey) {
        if (dayListeners.has(dateKey)) return;

        const dayDocRef = doc(db, 'users', uid, 'days', dateKey);
        const unsubscribe = onSnapshot(dayDocRef, (docSnapshot) => {
          const dayData = docSnapshot.exists() ? docSnapshot.data() : { hours: {} };
          periodDataCache.set(dateKey, dayData);
          if (dateKey === selectedKey) {
            applyDataToTable(dayData);
          }
          if (chartInitialized) {
              updateProgressChart();
          }
          console.log(`Loaded/Updated from cloud for ${dateKey}`);
        }, (error) => {
          console.error(`Load error for ${dateKey}:`, error);
        });
        dayListeners.set(dateKey, unsubscribe);
      }

      function updateSubscriptions(uid) {
        const selectedKey = selectedDate.toISOString().split('T')[0];
        let requiredDates = [];

        if (currentPeriod === 'daily') {
          requiredDates = [selectedKey];
        } else if (currentPeriod === 'weekly') {
          for (let i = 0; i < 7; i++) {
            let d = new Date(selectedDate);
            d.setDate(d.getDate() - i);
            requiredDates.push(d.toISOString().split('T')[0]);
          }
        } else if (currentPeriod === 'monthly') {
          for (let i = 0; i < 30; i++) {
            let d = new Date(selectedDate);
            d.setDate(d.getDate() - i);
            requiredDates.push(d.toISOString().split('T')[0]);
          }
        }

        for (let [key, unsub] of dayListeners.entries()) {
          if (!requiredDates.includes(key)) {
            unsub();
            dayListeners.delete(key);
            periodDataCache.delete(key);
          }
        }

        requiredDates.forEach(key => subscribeToDay(uid, key, selectedKey));
      }

      function applyDataToTableFromCache() {
        const selectedKey = selectedDate.toISOString().split('T')[0];
        const dayData = periodDataCache.get(selectedKey) || { hours: {} };
        applyDataToTable(dayData);
      }

      function applyDataToTable(dayData) {
        hours.forEach(hour => {
          const hourData = dayData.hours?.[hour] || {};
          const taskTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="task"]`);
          const taskTemplateSelect = document.querySelector(`select.task-template-select[data-hour="${hour}"]`);
          const doneTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="done"]`);
          const prioritySelect = document.querySelector(`select[data-hour="${hour}"][data-type="priority"]`);
          const completedBtn = document.querySelector(`.completed-btn[data-hour="${hour}"]`);
          const lostBtn = document.querySelector(`.lost-btn[data-hour="${hour}"]`);

          if (taskTextarea) {
            taskTextarea.value = hourData.task || '';
            updatePriorityVisual(taskTextarea, hourData.priority || 'none');
          }
          if (taskTemplateSelect) {
            if (userTasks.some(t => t.text === hourData.task)) {
                taskTemplateSelect.value = hourData.task;
            } else {
                taskTemplateSelect.value = '';
            }
          }

          if (doneTextarea) doneTextarea.value = hourData.done || '';
          if (prioritySelect) prioritySelect.value = hourData.priority || 'none';

          completedBtn?.classList.remove('active');
          lostBtn?.classList.remove('active');
          if (hourData.status === 'completed') completedBtn?.classList.add('active');
          else if (hourData.status === 'lost') lostBtn?.classList.add('active');
        });
      }

      function updateProgressChart() {
        if (!progressChart) {
          console.warn('Chart not initialized yet - skipping update');
          return;
        }

        let completed = 0;
        let lost = 0;
        let pending = 0;
        let totalHours = 0;

        if (currentPeriod === 'daily') {
          hours.forEach(hour => {
            const completedBtn = document.querySelector(`.completed-btn[data-hour="${hour}"]`);
            const lostBtn = document.querySelector(`.lost-btn[data-hour="${hour}"]`);
            if (completedBtn?.classList.contains('active')) completed++;
            else if (lostBtn?.classList.contains('active')) lost++;
          });
          pending = 24 - completed - lost;
          totalHours = 24;
        } else {
          for (let dayData of periodDataCache.values()) {
            let dayCompleted = 0;
            let dayLost = 0;
            for (let h = 0; h < 24; h++) {
              const status = dayData.hours?.[h]?.status || 'pending';
              if (status === 'completed') dayCompleted++;
              else if (status === 'lost') dayLost++;
            }
            completed += dayCompleted;
            lost += dayLost;
            totalHours += 24;
          }
          pending = totalHours - completed - lost;
        }

        progressChart.data.datasets[0].data = [completed, lost, pending];
        progressChart.update();

        const totalTracked = completed + lost;
        const percent = totalTracked > 0 ? Math.round((completed / totalTracked) * 100) : 0;
        progressText.textContent = `Progress: ${percent}% completed (of tracked hours)`;

        if (totalTracked > 0 && percent >= 70) {
          periodStatus.textContent = `${capitalize(currentPeriod)} Status: Success!`;
          periodStatus.className = 'day-status status-done';
        } else if (totalTracked > 0) {
          periodStatus.textContent = `${capitalize(currentPeriod)} Status: Needs Improvement`;
          periodStatus.className = 'day-status status-lost';
        } else {
          periodStatus.textContent = `${capitalize(currentPeriod)} Status: Not enough data`;
          periodStatus.className = 'day-status status-lost';
        }
      }

      async function resetDay() {
        if (!auth.currentUser) return;

        hours.forEach(hour => {
          const taskTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="task"]`);
          const taskTemplateSelect = document.querySelector(`select.task-template-select[data-hour="${hour}"]`);
          const doneTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="done"]`);
          const prioritySelect = document.querySelector(`select[data-hour="${hour}"][data-type="priority"]`);
          const completedBtn = document.querySelector(`.completed-btn[data-hour="${hour}"]`);
          const lostBtn = document.querySelector(`.lost-btn[data-hour="${hour}"]`);

          if (taskTextarea) {
            taskTextarea.value = '';
            updatePriorityVisual(taskTextarea, 'none');
          }
          if (taskTemplateSelect) taskTemplateSelect.value = '';
          if (doneTextarea) doneTextarea.value = '';
          if (prioritySelect) prioritySelect.value = 'none';
          completedBtn?.classList.remove('active');
          lostBtn?.classList.remove('active');
        });

        try {
          const dateKey = selectedDate.toISOString().split('T')[0];
          await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'days', dateKey));
          periodDataCache.delete(dateKey);
          console.log('Day reset in cloud and cache');
        } catch (error) {
          console.error('Reset error:', error);
          alert('Error resetting day: ' + error.message);
        }
        updateProgressChart();
      }

      function enablePlanner(enabled) {
        const textareas = document.querySelectorAll('textarea');
        const buttons = document.querySelectorAll('.status-btn');
        const selects = document.querySelectorAll('select.priority-select');
        const taskTemplateSelects = document.querySelectorAll('select.task-template-select');

        datePicker.disabled = !enabled;
        resetDayBtn.disabled = !enabled;
        periodSelector.disabled = !enabled;
        quickAddTaskBtn.disabled = !enabled;
        manageTasksBtn.disabled = !enabled;

        textareas.forEach(ta => { ta.disabled = !enabled; });
        buttons.forEach(btn => { btn.style.pointerEvents = enabled ? 'auto' : 'none'; btn.style.opacity = enabled ? 1 : 0.5; });
        selects.forEach(sel => { sel.disabled = !enabled; });
        taskTemplateSelects.forEach(sel => { sel.disabled = !enabled; });
      }

      function clearPlanner() {
        hours.forEach(hour => {
          const taskTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="task"]`);
          const taskTemplateSelect = document.querySelector(`select.task-template-select[data-hour="${hour}"]`);
          const doneTextarea = document.querySelector(`textarea[data-hour="${hour}"][data-type="done"]`);
          const prioritySelect = document.querySelector(`select[data-hour="${hour}"][data-type="priority"]`);
          const completedBtn = document.querySelector(`.completed-btn[data-hour="${hour}"]`);
          const lostBtn = document.querySelector(`.lost-btn[data-hour="${hour}"]`);

          if (taskTextarea) {
            taskTextarea.value = '';
            updatePriorityVisual(taskTextarea, 'none');
          }
          if (taskTemplateSelect) taskTemplateSelect.value = '';
          if (doneTextarea) doneTextarea.value = '';
          if (prioritySelect) prioritySelect.value = 'none';
          completedBtn?.classList.remove('active');
          lostBtn?.classList.remove('active');
        });
        updateProgressChart();
      }

      console.log('Network status:', navigator.onLine ? 'Online' : 'Offline');
      window.addEventListener('online', () => console.log('Network online'));
      window.addEventListener('offline', () => console.log('Network offline'));
    });
  </script>
</body>
</html>
